{% extends "base.html" %}

{% block title %}{{ horse.name }} - JRA競馬予想アプリ{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="{{ url_for('main.index') }}">ホーム</a></li>
                <li class="breadcrumb-item"><a href="{{ url_for('entities.horse_list') }}">馬一覧</a></li>
                <li class="breadcrumb-item active">{{ horse.name }}</li>
            </ol>
        </nav>
    </div>
</div>

<div class="row">
    <div class="col-12">
        <h1 class="mb-4">
            <i class="bi bi-award"></i> {{ horse.name }}
        </h1>
    </div>
</div>

<div class="row">
    <div class="col-lg-8">
        <!-- Horse Info -->
        <div class="card mb-4">
            <div class="card-header bg-primary text-white">
                <i class="bi bi-info-circle"></i> 基本情報
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        {% if horse.sex %}
                            <p><strong>性別:</strong> {{ horse.sex }}</p>
                        {% endif %}
                        {% if horse.age %}
                            <p><strong>年齢:</strong> {{ horse.age }}歳</p>
                        {% endif %}
                        {% if horse.color %}
                            <p><strong>毛色:</strong> {{ horse.color }}</p>
                        {% endif %}
                    </div>
                    <div class="col-md-6">
                        {% if horse.sire %}
                            <p><strong>父:</strong> {{ horse.sire }}</p>
                        {% endif %}
                        {% if horse.dam %}
                            <p><strong>母:</strong> {{ horse.dam }}</p>
                        {% endif %}
                        {% if horse.netkeiba_horse_id %}
                            <p><strong>JRA ID:</strong> <small>{{ horse.netkeiba_horse_id }}</small></p>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>

        <!-- Recent Results -->
        <div class="card">
            <div class="card-header bg-success text-white">
                <i class="bi bi-trophy"></i> 最近の成績
            </div>
            <div class="card-body">
                {% if results %}
                    <div class="table-responsive">
                        <table class="table table-striped table-hover">
                            <thead>
                                <tr>
                                    <th>日付</th>
                                    <th>競馬場</th>
                                    <th>レース</th>
                                    <th>着順</th>
                                    <th>騎手</th>
                                    <th>タイム</th>
                                    <th>人気</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for result, entry, race in results %}
                                    <tr class="{{ 'table-warning' if result.finish_position == 1 else 'table-info' if result.finish_position <= 3 else '' }}">
                                        <td>
                                            <small>{{ race.race_date.strftime('%Y/%m/%d') if race.race_date else 'TBD' }}</small>
                                        </td>
                                        <td>{{ race.track.name if race.track else '-' }}</td>
                                        <td>
                                            <a href="{{ url_for('main.race_detail', race_id=race.id) }}">
                                                {{ race.race_number }}R
                                            </a>
                                        </td>
                                        <td>
                                            <strong>{{ result.finish_position }}</strong>
                                            {% if result.finish_position == 1 %}
                                                <i class="bi bi-trophy-fill text-warning"></i>
                                            {% endif %}
                                        </td>
                                        <td>
                                            <small>{{ entry.jockey.name if entry.jockey else '-' }}</small>
                                        </td>
                                        <td>{{ result.finish_time if result.finish_time else '-' }}</td>
                                        <td>{{ result.popularity if result.popularity else '-' }}</td>
                                    </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                {% else %}
                    <p class="text-muted mb-0">成績データがありません</p>
                {% endif %}
            </div>
        </div>
    </div>

    <div class="col-lg-4">
        <!-- Statistics -->
        <div class="card mb-3">
            <div class="card-header bg-info text-white">
                <i class="bi bi-graph-up"></i> 通算成績
            </div>
            <div class="card-body">
                <p class="mb-2"><strong>出走数:</strong> {{ stats.total_results }}</p>
                <p class="mb-2">
                    <strong>勝利:</strong> {{ stats.wins }}
                    <span class="badge bg-success">{{ '{:.1%}'.format(stats.win_rate) if stats.win_rate else '0.0%' }}</span>
                </p>
                <p class="mb-0">
                    <strong>連対:</strong> {{ stats.places }}
                    <span class="badge bg-info">{{ '{:.1%}'.format(stats.place_rate) if stats.place_rate else '0.0%' }}</span>
                </p>
            </div>
        </div>
    </div>
</div>

<!-- Performance Charts -->
<div class="row mt-4">
    <div class="col-lg-6 mb-4">
        <div class="card">
            <div class="card-header">
                <i class="bi bi-graph-up-arrow"></i> 着順推移（直近15走）
            </div>
            <div class="card-body">
                {% if position_chart_labels and position_chart_data %}
                    <canvas id="positionTrendChart" style="max-height: 300px;"></canvas>
                {% else %}
                    <p class="text-muted mb-0">データがありません</p>
                {% endif %}
            </div>
        </div>
    </div>

    <div class="col-lg-6 mb-4">
        <div class="card">
            <div class="card-header">
                <i class="bi bi-rulers"></i> 距離別勝率
            </div>
            <div class="card-body">
                {% if distance_labels and distance_win_rates %}
                    <canvas id="distanceStatsChart" style="max-height: 300px;"></canvas>
                {% else %}
                    <p class="text-muted mb-0">データがありません</p>
                {% endif %}
            </div>
        </div>
    </div>

    <div class="col-lg-6 mb-4">
        <div class="card">
            <div class="card-header">
                <i class="bi bi-cloud-sun"></i> 馬場状態別成績
            </div>
            <div class="card-body">
                {% if condition_labels and condition_win_rates %}
                    <canvas id="trackConditionChart" style="max-height: 300px;"></canvas>
                {% else %}
                    <p class="text-muted mb-0">データがありません</p>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // 着順推移チャート
    const positionLabels = {{ position_chart_labels | tojson | safe }};
    const positionData = {{ position_chart_data | tojson | safe }};

    if (positionLabels && positionLabels.length > 0) {
        const ctx1 = document.getElementById('positionTrendChart');
        if (ctx1) {
            new Chart(ctx1, {
                type: 'line',
                data: {
                    labels: positionLabels,
                    datasets: [{
                        label: '着順',
                        data: positionData,
                        borderColor: 'rgb(255, 193, 7)',
                        backgroundColor: 'rgba(255, 193, 7, 0.1)',
                        tension: 0.3,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            reverse: true,
                            beginAtZero: false,
                            ticks: {
                                stepSize: 1,
                                callback: function(value) {
                                    return value + '着';
                                }
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return context.parsed.y + '着';
                                }
                            }
                        }
                    }
                }
            });
        }
    }

    // 距離別勝率チャート
    const distanceLabels = {{ distance_labels | tojson | safe }};
    const distanceWinRates = {{ distance_win_rates | tojson | safe }};

    if (distanceLabels && distanceLabels.length > 0) {
        const ctx2 = document.getElementById('distanceStatsChart');
        if (ctx2) {
            new Chart(ctx2, {
                type: 'bar',
                data: {
                    labels: distanceLabels,
                    datasets: [{
                        label: '勝率',
                        data: distanceWinRates,
                        backgroundColor: 'rgba(13, 110, 253, 0.7)',
                        borderColor: 'rgb(13, 110, 253)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 100,
                            ticks: {
                                callback: function(value) {
                                    return value + '%';
                                }
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return '勝率: ' + context.parsed.y + '%';
                                }
                            }
                        }
                    }
                }
            });
        }
    }

    // 馬場状態別成績チャート
    const conditionLabels = {{ condition_labels | tojson | safe }};
    const conditionWinRates = {{ condition_win_rates | tojson | safe }};
    const conditionPlaceRates = {{ condition_place_rates | tojson | safe }};

    if (conditionLabels && conditionLabels.length > 0) {
        const ctx3 = document.getElementById('trackConditionChart');
        if (ctx3) {
            new Chart(ctx3, {
                type: 'bar',
                data: {
                    labels: conditionLabels,
                    datasets: [
                        {
                            label: '勝率',
                            data: conditionWinRates,
                            backgroundColor: 'rgba(255, 193, 7, 0.7)',
                            borderColor: 'rgb(255, 193, 7)',
                            borderWidth: 1
                        },
                        {
                            label: '複勝率',
                            data: conditionPlaceRates,
                            backgroundColor: 'rgba(13, 202, 240, 0.7)',
                            borderColor: 'rgb(13, 202, 240)',
                            borderWidth: 1
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 100,
                            ticks: {
                                callback: function(value) {
                                    return value + '%';
                                }
                            }
                        }
                    },
                    plugins: {
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return context.dataset.label + ': ' + context.parsed.y + '%';
                                }
                            }
                        }
                    }
                }
            });
        }
    }
});
</script>
{% endblock %}
