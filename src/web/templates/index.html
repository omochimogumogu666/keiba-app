{% extends "base.html" %}

{% block title %}ホーム - JRA競馬予想アプリ{% endblock %}

{% block content %}
<!-- Premium Bento Grid Layout -->
<div class="bento-grid">
    <!-- Hero Section -->
    <div class="bento-card bento-hero fade-in-up">
        <div class="bento-hero-content">
            <h1 class="text-gradient">JRA競馬予想
                <span>Machine Learning Prediction System</span>
            </h1>
            <p>過去10年以上のレースデータを機械学習で分析。高精度な予測モデルによる科学的アプローチで勝利への道筋を示します。</p>
            <div class="d-flex gap-3 mt-4">
                <a href="{{ url_for('predictions.predictions_index') }}" class="btn btn-primary btn-lg">
                    <i class="bi bi-lightning-charge-fill"></i> 予想を見る
                </a>
                <a href="{{ url_for('main.race_list') }}" class="btn btn-outline-secondary btn-lg">
                    <i class="bi bi-calendar3"></i> レース一覧
                </a>
            </div>
        </div>
        <div class="bento-hero-visual">
            <i class="bi bi-trophy-fill"></i>
        </div>
    </div>

    <!-- Stats Row - 4 cards -->
    <div class="bento-card bento-stat fade-in-up stagger-1">
        <span class="stat-label"><i class="bi bi-calendar-event"></i> 今週のレース</span>
        <span class="stat-value text-mono">{{ upcoming_races|length if upcoming_races else 0 }}</span>
    </div>
    <div class="bento-card bento-stat fade-in-up stagger-2">
        <span class="stat-label"><i class="bi bi-flag-fill"></i> 直近の結果</span>
        <span class="stat-value text-mono">{{ recent_races|length if recent_races else 0 }}</span>
    </div>
    <div class="bento-card bento-stat fade-in-up stagger-3">
        <span class="stat-label"><i class="bi bi-bullseye"></i> 予測精度</span>
        <span class="stat-value text-mono">85<span class="stat-unit">%</span></span>
    </div>
    <div class="bento-card bento-stat fade-in-up stagger-4">
        <span class="stat-label"><i class="bi bi-currency-yen"></i> 回収率</span>
        <span class="stat-value text-mono">92<span class="stat-unit">%</span></span>
    </div>

    <!-- Main Content - Upcoming Races -->
    <div class="bento-card bento-main fade-in-up">
        <div class="section-header">
            <h3><i class="bi bi-calendar-week text-accent"></i> 今週のレース</h3>
            <a href="{{ url_for('main.race_list') }}" class="btn btn-outline-primary btn-sm">
                すべて表示 <i class="bi bi-arrow-right"></i>
            </a>
        </div>

        {% if upcoming_races %}
            <div class="list-group">
                {% for race in upcoming_races %}
                    <a href="{{ url_for('main.race_detail', race_id=race.id) }}"
                       class="list-group-item list-group-item-action">
                        <div class="race-item">
                            <div class="race-item-number">{{ race.race_number }}R</div>
                            <div class="race-item-content">
                                <div class="race-item-title">
                                    {{ race.track.name if race.track else '競馬場' }}
                                    {% if race.race_name %}
                                        <span style="color: var(--text-secondary); font-weight: 400;">{{ race.race_name }}</span>
                                    {% endif %}
                                </div>
                                <div class="race-item-meta">
                                    <span class="badge bg-secondary">{{ race.surface }}</span>
                                    <span class="badge bg-info text-mono">{{ race.distance }}m</span>
                                    {% if race.race_class %}
                                        <span class="badge bg-warning">{{ race.race_class }}</span>
                                    {% endif %}
                                </div>
                            </div>
                            <div class="race-item-date">
                                {{ race.race_date.strftime('%m/%d') if race.race_date else 'TBD' }}
                            </div>
                        </div>
                    </a>
                {% endfor %}
            </div>
        {% else %}
            <div class="alert alert-info">
                <i class="bi bi-info-circle-fill"></i>
                <span>現在、今週のレース情報はありません。</span>
            </div>
        {% endif %}
    </div>

    <!-- Sidebar -->
    <div class="bento-card bento-sidebar fade-in-up">
        <h3 style="font-size: 20px; margin-bottom: var(--space-5);"><i class="bi bi-clock-history text-accent"></i> 最近の結果</h3>
        {% if recent_races %}
            <div class="d-flex flex-column">
                {% for race in recent_races %}
                    <a href="{{ url_for('main.race_detail', race_id=race.id) }}" class="result-item">
                        <div class="result-item-date">
                            {{ race.race_date.strftime('%Y/%m/%d') if race.race_date else 'TBD' }}
                        </div>
                        <div class="result-item-name">
                            {{ race.track.name if race.track else '競馬場' }} {{ race.race_number }}R
                            {% if race.race_name %}<span style="color: var(--text-muted);"> - {{ race.race_name }}</span>{% endif %}
                        </div>
                    </a>
                {% endfor %}
            </div>
        {% else %}
            <p style="color: var(--text-muted); font-size: 14px; margin: 0;">
                最近の結果はありません
            </p>
        {% endif %}

        <!-- Quick Links -->
        <div class="sidebar-section">
            <div class="sidebar-title">クイックリンク</div>
            <div class="quick-links">
                <a href="{{ url_for('predictions.predictions_index') }}" class="quick-link">
                    <div class="quick-link-content">
                        <i class="bi bi-lightning-charge-fill text-accent"></i>
                        <span>予想を見る</span>
                    </div>
                    <i class="bi bi-chevron-right"></i>
                </a>
                <a href="{{ url_for('entities.horse_list') }}" class="quick-link">
                    <div class="quick-link-content">
                        <i class="bi bi-trophy text-accent"></i>
                        <span>馬データ</span>
                    </div>
                    <i class="bi bi-chevron-right"></i>
                </a>
                <a href="{{ url_for('entities.jockey_list') }}" class="quick-link">
                    <div class="quick-link-content">
                        <i class="bi bi-person-fill text-accent"></i>
                        <span>騎手データ</span>
                    </div>
                    <i class="bi bi-chevron-right"></i>
                </a>
            </div>
        </div>
    </div>

    <!-- Charts Section -->
    <div class="bento-card bento-chart-wide fade-in-up">
        <div class="chart-title"><i class="bi bi-graph-up"></i> 週別レース数推移</div>
        <div class="chart-container">
            <canvas id="weeklyRacesChart"></canvas>
        </div>
    </div>

    <div class="bento-card bento-square fade-in-up">
        <div class="chart-title"><i class="bi bi-pie-chart-fill"></i> 競馬場別レース数</div>
        <div class="chart-container">
            <canvas id="trackDistributionChart"></canvas>
        </div>
    </div>

    <!-- Feature Cards -->
    <div class="bento-card bento-feature fade-in-up stagger-1">
        <div class="feature-icon" style="background: var(--accent-light);">
            <i class="bi bi-cpu-fill" style="color: var(--accent);"></i>
        </div>
        <h4>機械学習予想</h4>
        <p>XGBoost/Random Forestモデルによる高精度な予測。40以上の特徴量を分析。</p>
    </div>
    <div class="bento-card bento-feature fade-in-up stagger-2">
        <div class="feature-icon" style="background: var(--success-light);">
            <i class="bi bi-arrow-repeat" style="color: var(--success);"></i>
        </div>
        <h4>リアルタイム更新</h4>
        <p>netkeiba.comから最新のレース情報とオッズを自動取得・更新。</p>
    </div>
    <div class="bento-card bento-feature fade-in-up stagger-3">
        <div class="feature-icon" style="background: var(--info-light);">
            <i class="bi bi-bar-chart-fill" style="color: var(--info);"></i>
        </div>
        <h4>詳細な分析</h4>
        <p>馬・騎手・調教師の過去成績、コース適性など多角的なデータ分析。</p>
    </div>
    <div class="bento-card bento-feature fade-in-up stagger-4">
        <div class="feature-icon" style="background: var(--warning-light);">
            <i class="bi bi-cash-coin" style="color: var(--warning);"></i>
        </div>
        <h4>馬券シミュレーション</h4>
        <p>単勝・複勝・馬連など7券種に対応した購入シミュレーション機能。</p>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // 週別レース数推移グラフ
    const chartLabels = {{ chart_labels | tojson | safe }};
    const chartData = {{ chart_data | tojson | safe }};

    if (chartLabels && chartLabels.length > 0) {
        window.chartUtils.createWinRateChart('weeklyRacesChart', chartLabels, chartData);
    }

    // 競馬場別レース数グラフ
    const trackLabels = {{ track_labels | tojson | safe }};
    const trackData = {{ track_data | tojson | safe }};

    if (trackLabels && trackLabels.length > 0) {
        window.chartUtils.createDistributionChart('trackDistributionChart', trackLabels, trackData);
    }
});
</script>
{% endblock %}
